define("nowcoder/1.2.1125/javascripts/site/widget/questionCmt",["nc","cpn","ncpc","../../util/util","../../core/siteConfig","../../component/subComment","../../action/contest","../../component/editorSub/hEditor/index","ncPlugin/kindeditor/kindeditor","ncPlugin/kindeditor/kindeditor/themes/nowcoder/nowcoder.css","../../action/code","ncPlugin/highlighter/highlighter","../../util/littleAction","../../action/note"],function(e,t,i){var n=e("nc"),a=e("cpn"),r=e("ncpc"),p=n.$,o=n.Browser,d=n.Str,c=n.Base,u=n.Limit,m=n.Time,s=n.Uri,l=n.Dom,f=n.CodeLang,h=a.PopupImage,v=a.Popup,g=a.Select,w=r.PopupGtCode,k=r.PopupLogin,b=e("../../util/util"),y=e("../../core/siteConfig"),C=e("../../component/subComment"),I=e("../../component/editorSub/hEditor/index"),T=e("../../action/contest"),j=e("../../action/code"),L=e("ncPlugin/highlighter/highlighter"),x=e("../../util/littleAction"),D=56;function A(){var e=this;if(e.canKeepTop){e.navVal||(e.navVal={x:p(window).width()/2,y:D});var t=e.navVal,i=p(document.elementFromPoint(t.x,t.y)),n=p(document.elementFromPoint(t.x,t.y+120)),a=p(i.closest("li.answer-list-item")),r=p(n.closest("li.answer-list-item")),o=e.currentLi;if(r.get(0)!==a.get(0))return o&&o.find("div.votebar").removeClass("keep-top"),void(e.currentLi=null);a.get(0)&&o&&o.get(0)===a.get(0)||(o&&o.find("div.votebar").removeClass("keep-top"),e.currentLi=null,a.get(0)&&(a.find("div.votebar").addClass("keep-top"),this.currentLi=a))}}function M(){var o=this,e=o.problem.type,t=p.trim(o.commentIpt.text());function i(){var r=p.trim(o.commentIpt.val());T.comment({body:{entityType:y.type.problem,entityId:o.problem.id,commentContent:r,toUserId:0,toCommentId:0},call:function(e){v.show({noUnique:!0,content:"你的答案已提交",duration:1500,type:"ok",close:function(){l.scrollToEl({el:p("div.js-discussion"),ext:0<p("div.email-validate").length?-91:-60,animation:!0})}}),o.commentIpt.val(""),o.comment.count++,p("span.analytic-discuss-num").html("共有"+o.comment.count+"条讨论");var t={id:e.commentId,headImg:o.globalInfo.ownerTinyHead,authorId:o.globalInfo.ownerId,authorName:o.globalInfo.ownerName,content:r,createTime:(new Date).getTime(),commentCnt:0,isLiked:!1,likes:0,isAdmin:o.problem.id};if(o.comment.all.push(t),o.cmtMap[e.commentId]=t,o.cmtTipsDv.hide(),o.cmtNoneDv.hide(),o.firstCommentEl){var i=p("li.more-answer");(0===i.length?o.firstCommentEl:i).after(o.getCmtStr(t))}else o.cmtListUl.prepend(o.getCmtStr(t)).show();L.init();var n=o.commentIpt.getEl().closest("div.editor-box");o.commentIpt.destroy(),n.remove();var a="/questionTerminal/"+o.problem.uuid;a=s.addParam({toCommentId:e.commentId},a),p("#jsDealAnswer").replaceWith('<a href="'+a+'" class="btn float-right btn-primary" target="_blank">修改解析</a>')},error:function(e){v.alert(e.msg)}})}t?1!==e&&2!==e||!/^([a-z]|[A-Z]|[0-9]|\s|[,，、])+$/.test(t)?i():v.confirm("除了答案外，还需要写清楚解题思路哦~~只写答案可能会被管理员删除的，确定现在提交吗",function(){i()}):v.alert("内容不能为空")}function N(e){var t=p(e.currentTarget),i=p("#jsEditorModuleBody"),n=i.parent();if(0!==n.length&&!u.mark(i)){var a="none"===n.css("display");o.ie()?(n[a?"show":"hide"](),n.height("auto"),u.clear(i)):n[a?"slideDown":"slideUp"](250,function(){n.height("auto"),u.clear(i)}),a&&(this.commentIpt.resize("100%"),this.commentIpt.autoHeight()),t.html(a?"取消发表":"添加解析")}}function E(e){if(window.isLogin){var i=p(e.currentTarget),t=i.attr("data-type");if(("asked"===t||"asking"===t)&&!u.mark(i)){var n="asked"===t;T[n?"cancelWantAnswer":"wantAnswer"]({body:{id:this.problem.id},call:function(e){var t=+i.attr("data-count")||0;t+=n?-1:1,i.attr("data-count",t),i.html((n?"求解答":"已求解答")+"("+t+")"),i.attr("data-type",n?"asking":"asked")},error:function(e){v.alert(e.msg)},always:function(){u.pause(i)}})}}}function P(e){var t=p(e.currentTarget),i=t.closest("div.answer-content"),n=i.attr("data-cmt-id"),a=this.cmtMap[n],r=!!i.attr("data-recommend");if(0!==i.length&&n&&a&&!u.mark(t)){var o=this.cmtItemMap;o[n]||(o[n]={item:new C({renderTo:i,comment:a,recommend:r,inputWidth:798,listeners:{addCmt:function(){a.commentCnt++,t.html("回复("+a.commentCnt+")")},delCmt:function(){a.commentCnt--,t.html("回复("+a.commentCnt+")")}},firstCount:e.firstCount,isAdmin:this.problem.isAdmin}),showed:!1});var s=o[n];if(s.showed)try{s.item.getEl().slideUp(200,function(){s.item.destroy(),o[n]=null,u.pause(t)})}catch(c){s.item.destroy(),o[n]=null,u.pause(t)}else s.item.show(),s.showed=!0,u.pause(t)}}function q(e){var t=this,i=p(e.currentTarget).parents("div.answer-content"),n=(i.attr("data-recommend"),i.attr("data-cmt-id")),a=t.cmtMap[n];i&&n&&a&&v.confirm("确定设为参考答案？",function(){T.setRefAnswer({body:{commentId:n,questionId:t.problem.id},call:function(e){t.popupRightAnswer(function(){window.location.reload()})},error:function(e){v.alert(e.msg)}})})}function H(e){var t=p(e.currentTarget).parents("div.answer-content"),i=(t.attr("data-recommend"),t.attr("data-cmt-id")),n=this.cmtMap[i];t&&i&&n&&v.confirm("确定取消设为参考答案？",function(){T.unsetRefAnswer({body:{commentId:i},call:function(e){v.tips("操作成功",function(){window.location.reload()})},error:function(e){v.alert(e.msg)}})})}function S(e){var t=p(e.currentTarget),i=t.parents("div.answer-content"),n=i.attr("data-cmt-id"),a=this.cmtMap[n];i&&n&&a&&!u.mark(t)&&v.confirm("确定删除评论？",function(){T.delComment({body:{id:n},call:function(){v.tips("操作成功",function(){window.location.reload()})},error:function(e){v.alert(e.msg)},always:function(){u.pause(t)}})},function(){u.clear(t)})}function F(e){var n=p(e.currentTarget),t=n.closest("li.answer-list-item").find("div.answer-content"),i=(t.attr("data-recommend"),t.attr("data-cmt-id")),a=this.cmtMap[i];if(t&&i&&a&&!u.mark(n)){var r=a.isLiked;T[r?"unlike":"like"]({body:{id:i,type:y.type.comment,likeType:0},call:function(e){a.isLiked=!r,a.likes=e.count,a.isLiked&&a.isDisLiked&&(a.isDisLiked=!1);var t=n.children("span.count"),i=n.siblings(".down");a.isLiked?(n.addClass("pressed").attr("title","取消赞同"),i.removeClass("pressed").attr("title","反对")):(n.removeClass("pressed"),n.attr("title","取消反对")),t.text(a.likes+"")},error:function(e){v.alert(e.msg)},always:function(){u.pause(n)}})}}function B(t){var i=this,n=i.comment.first;function a(e){T.getRefAnswer({params:{questionId:i.problem.id},query:e||{},call:function(e){n.content=e.data,n.isComplete=!0,i.firstCommentEl.find("div.answer-brief").html(e.data),L.init()},error:function(e){1125===e.code&&(i.reqCaptcha=!0,B.call(i,t))}})}window.isLogin&&n&&!n.isComplete&&(i.reqCaptcha?w.show({type:y.captcha.refAnswer,call:function(e){i.reqCaptcha=!1,a(e)}}):a())}function U(e){var i=p(e.currentTarget),t=i.closest("li.answer-list-item").find("div.answer-content"),n=(t.attr("data-recommend"),t.attr("data-cmt-id")),a=this.cmtMap[n];if(t&&n&&a&&!u.mark(i)){var r=a.isDisLiked;T[r?"unlike":"like"]({body:{id:n,type:y.type.comment,likeType:1},call:function(e){a.isDisLiked=!r,a.isDisLiked&&a.isLiked&&(a.isLiked=!1,a.likes--);var t=i.siblings(".up");a.isDisLiked?(i.addClass("pressed"),i.attr("title","取消反对"),t.removeClass("pressed"),t.attr("title","赞同")):(i.removeClass("pressed"),i.attr("title","反对")),t.find("span.count").html(a.likes)},error:function(e){v.alert(e.msg)},always:function(){u.pause(i)}})}}function R(e){var a=this,r=p(e.currentTarget);if(!u.mark(r)){var t=r.parents("div.answer-content"),o=t.attr("data-cmt-id"),s=a.cmtMap[o],c=a.problem.type,l=t.find("div.answer-brief"),d=p('<div class="editor-box"><div class="js-editor"></div><div class="txtarea-foot clearfix"><a class="btn float-right btn-primary btn-modify-sure" href="javascript:void(0);">确定</a><a class="btn btn-default float-right btn-modify-cancel" href="javascript:void(0);">取消</a></div></div>');l.replaceWith(d),d.find("a.btn-modify-cancel").one("click",function(){d.replaceWith(l),T.saveAnswerDraft({body:{entityId:a.problem.id,content:""}}),a._lastDraft=a.comment.draft="",u.clear(r),m.destroy()}),d.find("a.btn-modify-sure").on("click",function(e){var t=p(e.currentTarget),i=m.text();function n(){if(!u.mark(t)){var e=p.trim(m.val());T.editAnswer({body:{content:e,commentId:o},call:function(){s.content=e,l.html(e),d.replaceWith(l),u.clear(r),u.clear(t),L.init(),a._lastDraft=a.comment.draft="",m.destroy()},error:function(e){v.alert(e.msg),u.clear(t)}})}}i?1!==c&&2!==c||!/^([a-z]|[A-Z]|[0-9]|\s|[,，、])+$/.test(i)?n():v.confirm("除了答案外，还需要写清楚解题思路哦~~只写答案可能会被管理员删除的，确定现在提交吗",function(){n()}):v.alert("内容不能为空")});var m=new I({renderTo:d.find(".js-editor"),content:a._lastDraft||a.comment.draft||s.content,toolbarFixedTop:b.getNavHeight(),height:180,noCodeSelect:!0,needChangeEditor:!0,draftChange:function(e){T.saveAnswerDraft({body:{entityId:a.problem.id,content:e}}),a._lastDraft=e},afterChangeEditor:function(e){m=e}})}}function _(e){var t=this,i=p(e.currentTarget).closest("li"),n=t.correctPersonId=i.attr("data-id"),a=i.find("a.correct-person-name").text();if(n){var r=t.questionType,o="4"===r?"getBianChengAnswer":"5"===r?"getShejiAnswer":"6"===r?"getDataAnswer":"",s=t.answerCache;if(r&&t.lastCorrectPersonId!==n){p("ul.result-avatar-list li").removeClass("correct-person-checked").removeAttr("data-selected"),p("ul.result-avatar-list li[data-id="+n+"]").addClass("correct-person-checked").attr("data-selected","1"),p("#otherAnswer").remove(),t.lastCorrectPersonId=n;var c=i.closest("div.result-avatar-box"),l=p('<div id="otherAnswer" style="display:none;"></div>');c.append(l),s[n]?t[o](s[n],l,a):j.getOtherDoneInfo({query:{doneid:n},call:function(e){s[t.correctPersonId]=e,t[o](e,l,a)},error:function(e){t.lastCorrectPersonId=null,v.alert(e.msg)}})}}}function W(e){e.preventDefault();var t=p(e.currentTarget).attr("href");this.downloadIfr.attr("src",t)}function z(e){var t=p(e.currentTarget).attr("src");e.stopPropagation(),e.preventDefault(),t&&h.show(t)}i.exports={initialize:function Y(){var e=this;e.questionType=p("#questionType").val(),e.correctPersonId=null,e.lastCorrectPersonId=null,e.answerCache={},e.canKeepTop=(!o.ie()||9<=o.ie())&&document.elementFromPoint,A.call(e),c.copy(e,window,["problem","comment"]),e.comment.draft=(e.comment.draft||{}).content||"",e.globalInfo=c.clone(window.globalInfo),e.cmtMap={},e.cmtItemMap={},e.initEditor(),e.cmtListUl=p("#commentList"),e.cmtTipsDv=p("#commentTips"),e.cmtNoneDv=p("#commentNone"),e.renderCmt(),L.init(),x.follow({followCls:"click-follow",unfollowCls:"click-unfollow",entityId:e.problem.id,entityType:y.type.problem}),x.correction({el:p("a.click-correction"),entityId:e.problem.id,entityType:y.type.problem});var t=p("div.my-notes");x.note({container:t,editCls:["js-add-note"],foldCls:["fold-notes","show-all-notes"],delCls:["js-del-note"],entityId:e.problem.id,entityType:y.type.problem,noteId:t.attr("data-id"),ok:function(){window.location.reload()}}),l.fixedPos(p("div.pre-next-box"),function(e,t,i){e.css("bottom",Math.max(0,(i-t)/2))}),e.initCorrectLangueSelect()},initEvent:function $(){var e={"scroll window":A,"click a.click-pub-point":M,"click #jsDealAnswer":N},t={"click a.js-click-ask":E,"click a.click-reply":P,"click a.click-set-referanswer":q,"click a.click-unset-referanswer":H,"click a.click-del":S,"click div.answer-legend a.click-edit":R,"click button.click-like":F,"click a.show-ref-answer":B,"click button.click-dislike":U,"click div.answer-brief img":z,"click a.correct-person-btn":_,"click div.js-sheji-answer a.down-files":W};l.bind(e,t,this)},initCorrectLangueSelect:function V(){var e=this,i={},n=p("#jsCorrectPerson"),t=c.filter((e.problem.supportLanguages||"").split(","),function(e){return p.trim(e)}),a=e.problem.curLanguage;if(t.length<=1||0===n.length)return;var r=[];c.forEach(t,function(e){r.push({text:f.getNameById(e),value:e,checked:e===a})});var o=p('<div class="module-head-oprt"></div>');function s(e){var t=n.find("ul.result-avatar-list");if(t.html(""),n.find("#otherAnswer").remove(),n.find("#commentNone").remove(),!e||0===e.length)return n.append(['<div id="commentNone" class="blank-box">','<div class="blank-img"><img src="//static.nowcoder.com/images/res/company/empty/2.png">',"</div>","<p>这门语言还没有人通过，看看其他语言的代码吧！</p>","</div>"].join("")),void t.hide();var i="";c.forEach(e,function(e){i+=d.execTpl(['<li data-id="#{doneId}">','<div class="head-pic-bg">','<a href="/profile/#{uid}" target="_blank" class="head-pic"><img src="#{headurl}"></a>',"</div>",'<a href="/profile/#{uid}" target="_blank" class="correct-person-name">#{uname}</a>','<a href="javascript:void(0);" class="btn btn-primary correct-person-btn">TA的设计</a>',"</li>"].join(""),e,!0)}),t.html(i).show()}n.prepend(o),new g({renderTo:o,size:"small",options:r,change:function(){var t=this.val();if(i[t])return s(i[t]);T.correctPerson({query:{questionId:e.problem.id,language:t},call:function(e){i[t]=e.data,s(i[t])},error:function(e){v.alert(e.msg)}})}})},tpl:{shejiItem:["<li>",'<i class="subject-upload-item-icon"></i>','<span class="subject-upload-item-name">#{name}</span>','<a href="#{url}" target="_blank" class="btn btn-large btn-primary down-files">下载</a>',"</li>"].join("")},renderCmt:function K(){var t,i=this,e=i.comment.all;c.forEach(e,function(e){(i.cmtMap[e.id]=e).isRecommend&&(t=!0,i.comment.first=e)}),t&&(i.firstCommentEl=i.cmtListUl.find("li.js-first-comment"))},getCmtStr:function O(e,t,i){var n=this;n.cmtMap[e.id]=e;var a=[t?"":'<li class="answer-list-item clearfix">','<div class="votebar">','<button class="#{likeClass}" aria-pressed="false" title="#{likeNameNew}"><i class="vote-arrow"></i><span class="count">#{likes}</span></button>','<button class="#{dislikeClass}" aria-pressed="true" title="#{dislikeNameNew}"><i class="vote-arrow"></i></button>',"</div>",'<div class="answer-content clearfix" data-cmt-id="#{id}" data-dislikecnt="#{dislikes}" data-isdisliked="#{dislikeName}"',i?'data-recommend="1" ':"",">",'<div class="answer-info">','<a href="/profile/#{authorId}" class="answer-head"><img src="#{avatar}" alt="#{authorName}头像"></a>','<a class="answer-name" href="/profile/#{authorId}" title="#{authorName}">#{authorName}</a>',"</div>",'<div class="answer-brief nc-post-content">#{content}</div>','<div class="answer-legend">',e.edited?'<span class="answer-time">编辑于 #{updateTime}</span>':'<span class="answer-time">发表于 #{createTime}</span>','<a class="click-reply" href="javascript:void(0);">回复(#{commentCnt})</a>',!i&&n.problem.isAdmin?'<a class="click-set-referanswer" href="javascript:void(0);">设为参考答案</a>':"",i&&n.problem.isAdmin?'<a class="click-unset-referanswer" href="javascript:void(0);">取消设为参考答案</a>':"",e.authorId==n.globalInfo.ownerId||n.problem.isAdmin?'<a class="click-edit" href="javascript:void(0);">修改</a><a class="click-del" href="javascript:void(0);">删除</a>':"","</div>","</div>",t?"":"</li>"].join(""),r=new Date(e.createTime),o=new Date,s=r.getFullYear()===o.getFullYear()&&r.getMonth()===o.getMonth()&&r.getDate()===o.getDate(),c=new Date(e.updateTime),l=c.getFullYear()===o.getFullYear()&&c.getMonth()===o.getMonth()&&c.getDate()===o.getDate();return d.execTpl(a,{id:e.id,authorId:e.authorId,avatar:e.headImg||y.avatar.small,authorName:e.authorName,content:e.content,createTime:s?"今天 "+m.form(r,"HH:mm:ss"):m.form(r,"yyyy-MM-dd HH:mm:ss"),updateTime:l?"今天 "+m.form(c,"HH:mm:ss"):m.form(c,"yyyy-MM-dd HH:mm:ss"),commentCnt:e.commentCnt||0,likeName:e.isLiked?"已赞":"赞",likes:e.likes||0,dislikeName:e.isDisLiked?"已踩":"踩",dislikes:e.dislikes||0,likeClass:e.isLiked?"click-like up pressed":"click-like up",dislikeClass:e.isDisLiked?"click-dislike down pressed":"click-dislike down",likeNameNew:e.isLiked?"取消赞同":"赞同",dislikeNameNew:e.isDisLiked?"取消反对":"反对"})},initEditor:function Z(){var t=this;if(0===p("#jsEditorModuleBody").length)return;t.commentIpt=new I({renderTo:p("#jsEditorModuleBody"),content:t.comment.draft,toolbarFixedTop:b.getNavHeight(),placeholder:"请输入正确的答案及解题思路",disabled:!window.isLogin,height:180,needChangeEditor:!0,clickMask:function(){window.isLogin||(t.commentIpt.blur(),k.show({loginCb:function(){window.location.reload()},registerCb:function(){window.location.reload()}}))},draftChange:function(e){window.isLogin&&T.saveAnswerDraft({body:{entityId:t.problem.id,content:e}})},afterChangeEditor:function(e){t.commentIpt=e}})},popupRightAnswer:function G(o){var s=this,c=s.problem.type;if(1!==c&&2!==c&&3!==c)return void(o&&o());v.show({title:"提示",content:"确认设为参考答案？",listeners:{render:function(){var e="";if(3===c)for(var t=0,i=s.problem.contentSize||0;t<i;t++)e+='<div style="margin-bottom:20px;"><input style="width:420px;" type="text" class="js-ipt" /></div>';else for(var n=s.problem.options,a="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),t=0,i=n.length;t<i;t++)e+=1===c?'<label style="display:inline-block;padding-right:10px;"><input style="width:20px" class="js-ipt" type="radio" value="'+n[t]+'" name="question">'+(a[t]||t)+"</label>":'<label style="display:inline-block;padding-right:10px;"><input style="width:20px" class="js-ipt" type="checkbox" value="'+n[t]+'" />'+(a[t]||t)+"</label>";this.popupContent.after('<div style="padding:20px;border-top:1px solid #ededed">'+e+"</div>")}},ok:function(){for(var e=this.getEl(),t=e.find("input.js-ipt"),i=[],n=3===c,a=0,r=t.length;a<r;a++)(n||p(t[a]).prop("checked"))&&i.push(p(t[a]).val());T.setRightAnswer({body:{questionId:s.problem.id,type:c,content:3===c?i.join("[$##$]"):null,rightOptions:3===c?null:1===c?i[0]:i.join(",")},call:function(){v.tips("操作成功",o)},error:function(e){v.tips(e.msg||"操作失败",o)}})},cancel:function(){o&&o()}})},getBianChengAnswer:function J(e,t){var i="";"js"in e||"css"in e||"html"in e?(e.css&&(i+='<pre class="prettyprint brush: css">'+d.encodeHTML(e.css||"")+"</pre>"),e.html&&(i+='<pre class="prettyprint brush: html">'+d.encodeHTML(e.html||"")+"</pre>"),e.js&&(i+='<pre class="prettyprint brush: js">'+d.encodeHTML(e.js||"")+"</pre>")):i+='<pre class="prettyprint">'+d.encodeHTML(e.content)+"</pre>";t.html(i),t.slideDown(250),L.init()},getShejiAnswer:function Q(e,t,i){var n='<h1><div class="result-score">Ta的本题得分:<span class="font-red">'+(e.score||0)+"</span></div>"+i+" 的答案</h1>";n+='<div class="design-answer-box">'+(e.content||"")+"</div>";var a=p.trim(e.urls||"").split(",");if(p.trim(e.urls)&&0<a.length){var r;n+='<div class="subject-upload-list js-sheji-answer"><div class="top-list-arrow"></div><ul>';for(var o=0,s=a.length;o<s;o++)r=a[o],n+=d.execTpl(this.tpl.shejiItem,{name:b.getFileName(r),url:r});n+="</ul></div>"}t.html(n),t.slideDown(250)},getDataAnswer:function X(e,t){this.getShejiAnswer(e,t)}}});